name: PR Bouncer Commands

on:
  workflow_call:
    inputs:
      upload_to_s3:
        description: 'Save decisions to S3'
        required: false
        type: boolean
        default: false
    secrets:
      AWS_ACCESS_KEY_ID:
        required: false
      AWS_SECRET_ACCESS_KEY:
        required: false
      AWS_REGION:
        required: false

permissions:
  pull-requests: write
  statuses: write

jobs:
  handle-command:
    if: >
      github.event.issue.pull_request &&
      (contains(github.event.comment.body, '/accept-risk') ||
      contains(github.event.comment.body, '/false-positive')) &&
      contains(fromJSON('["OWNER","MEMBER","COLLABORATOR"]'), github.event.comment.author_association)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout pr-bouncer scripts
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/pr-bouncer
          path: .pr-bouncer
          ref: v1

      - name: Process command
        id: process
        env:
          GITHUB_TOKEN: ${{ github.token }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          PR_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
          UPLOAD_TO_S3: ${{ inputs.upload_to_s3 }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
        run: |
          pip install boto3 -q
          python3 .pr-bouncer/scripts/process_command.py

      - name: Cleanup action checkout
        if: always()
        run: rm -rf .pr-bouncer